<!DOCTYPE html>
<html lang="cn">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>666</title>
    <script src="nlgl.js"></script>
    <script src="paipan.js"></script>
    <style>
        body {
            margin: 0; /*原来页面自带一个margin, 666*/
        }
        .container {
            display: flex;
            height: 25vh; 
            position: relative;
        }
        .box {
            flex: 1;
            display: block;
            position: relative; /* 让 .box 支持绝对定位的子元素相对于它定位 */
            border: 1px solid #000;
            border-radius: 5px;
            margin: 5px;
    /* 移除了justify-content和align-items，因为它们对于 display: block 无效 */
        }
        .shengxiao {
            font-size: larger;
            color: rgb(0, 0, 0);
            position: absolute; /* 绝对定位 */
            bottom: 0; /* 放置于底部 */
            left: 0; /* 放置于左侧 */
            margin: 1px;
            font-weight: bold;
        }
        .monthganzhi {
            font-size: larger;
            color: rgb(0, 0, 0);
            position: absolute; /* 绝对定位 */
            bottom: 20px; /* 放置于底部 */
            left: 0; /* 放置于左侧 */
            margin: 1px;
            font-weight: bold;
        }
        .lefttop1 {
            position: absolute;
            top: 3px;
            left: 0;
            font-size: large;
            writing-mode:vertical-lr;
            max-height: 50px;
            line-height: 100%;
            
        }
        .hua4 {
            border-radius: 4px; 
            position: absolute;
            top: 40%;
            left: 0;
            font-size: large;
        }
        .tw_shen {
            border-radius: 4px;
            position: absolute;
            bottom: 45px;
            left: 0;
            writing-mode:vertical-lr;
        }
        .rightbottom {
            position: absolute;
            right: 3px;
            bottom: 0;
            max-width: 35px;
        }
        .daxian {
            position: absolute;
            right: 0;
            bottom: 25px;
            left: 0;
            text-align: center; /* 水平居中 */
        }
        .shengong-info {
            font-size: small;
            color: #ff0000;
            position: absolute; /* 绝对定位 */
            right: 0;
            top:40%;
            margin: 2px;
            border: #ff0000 solid 1px;
            border-radius: 5px;
            padding-inline: 3px;
            writing-mode:vertical-lr;
        }
        .bottom-info {
            font-size: larger;
            color: red;
            position: absolute;
            right: 0;
            left: 0;
            bottom:0;
            margin: 1px;
            text-align: center;
        }
        .xingyao-info {
            color: gray;
            position: absolute;
            top: 40px;
            left: 0;
            font-size: large;
            writing-mode:vertical-lr;
            max-height: 1px;
            line-height: 100%;
        }
        input {
            width: 100%;
        }
        #sexinput {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="box" data-index="3"></div>
        <div class="box" data-index="4"></div>
        <div class="box" data-index="5"></div>
        <div class="box" data-index="6"></div>
    </div>
    <div class="container">

        <div class="box" data-index="2"></div>
        <div class="box" style="border: 0px;"><p id="resultDisplay"></p></div>
        <div class="box" style="border: 0px;"><p id="wuxingjuDisplay"></p></div>
        <div class="box" data-index="7"></div>
    </div>
    <div class="container">
        <div class="box" data-index="1"></div>
        <div class="box" style="border: 0px;">
            <label style="background-color: cornflowerblue; border-radius: 5px;"><input id="m" type="radio" name="sex" value="1"></label>
            <label style="background-color: palevioletred; border-radius: 5px;"><input id="f" type="radio" name="sex" value="-1"></label>
            
            <input type="text" id="yearInput" placeholder="输入年: 如2024"><br>
            <input type="text" id="monthInput" placeholder="输入月: 如6或06"><br>
            <input type="text" id="dayInput" placeholder="输入日: 如18或30"><br>
            <input type="text" id="timeInput" placeholder="输入时: 用24小时制，舍去分钟"><br>
            <button onclick="processAndDisplayYear()">go</button>
            <button onclick="clearInput()">clear</button>
        </div>
        <div class="box" style="border: 0px;text-align: center;">
            可计算日期范围: 1900-1-1~2099-12-31
        </div>
        <div class="box" data-index="8"></div>
    </div>
    <div class="container">
        <div class="box" data-index="0"></div>
        <div class="box" data-index="11"></div>
        <div class="box" data-index="10"></div>
        <div class="box" data-index="9"></div>
    </div>
    <script>

        let Yinput=document.getElementById("yearInput");
        let Minput=document.getElementById("monthInput");
        let Dinput=document.getElementById("dayInput");
        let Tinput=document.getElementById("timeInput");
        let currentDate=new Date();
        
        //自动填充当前年月日时↑
        const monthGZspans = document.querySelectorAll('.monthganzhi');
        

//↓性别选项↓
        let sex = -1;
        document.addEventListener('DOMContentLoaded', function() {
            
                const sexRadios = document.querySelectorAll('input[name="sex"]');

                // 为每个单选按钮添加点击事件监听器
                sexRadios.forEach(radio => {
                   radio.addEventListener('click', function() {
                       sex = this.value; // 更新sex变量的值
                    });
                });
        });
//性别选项
        
        const boxes = document.querySelectorAll('.box');
        function start(y,m,d,t,s){
            pan=paipan(y,m,d,t,s);//关键
            document.querySelectorAll('.box').forEach(clearElementContent);
            createOriginalDZ();
            
            addInBox("命宫",pan.minggong,"bottom-info");
            addInBox("身宫",pan.shengong,"shengong-info");
            document.getElementById('wuxingjuDisplay').innerText=wuxingju_str[pan.wuxing_ju];//设置五行局显示文本
            for(let i=0;i<gongwei.length;i++){addInBox(gongwei[i],(pan.minggong+i+1)%12,"bottom-info");}
            //另外11宫位↑
            creatAllStarInBox();
            console.log(pan);
            result =  `年天干地支: ${jybd[pan.yearst_tg]+zcym[pan.yearst_dz]}
            月天干地支: ${jybd[pan.monst_tg]+zcym[pan.monst_dz]}
            日天干地支: ${jybd[pan.day_tg]+zcym[pan.day_dz]}
            时天干地支: ${jybd[pan.time_tg]+zcym[pan.time_dz]}
            ${yy[pan.yysex==1?1:0]+sx[pan.sex]}
            `;
            document.getElementById('resultDisplay').innerText = result;
            mapMonthGZToBoxes();
        }
            
function clearInput(){
    document.getElementById('yearInput').value = "";
    document.getElementById('monthInput').value = "";
    document.getElementById('dayInput').value = "";
    document.getElementById('timeInput').value = "";
}

        


//↓启动计算
        function processAndDisplayYear() {
            let userInputyear = document.getElementById('yearInput').value;
            let userInputmonth = document.getElementById('monthInput').value;
            let userInputday = document.getElementById('dayInput').value;
            let userInputtime = document.getElementById('timeInput').value;

            function getMaxDaysInMonth(Month, year) {
                const date = new Date(year, Month, 0);
                return date.getDate();
            }
            function getNextDay(year, month, day) {
                let dateString = `${year}-${month}-${day}`;
                let date = new Date(dateString);

                date.setDate(date.getDate() + 1);

                let nextYear = date.getFullYear();
                let nextMonth = (date.getMonth() + 1).toString().padStart(2, '0');
                let nextDay = date.getDate().toString().padStart(2, '0');

                return {
                    y:nextYear,
                    m:nextMonth,
                    d:nextDay,
                };
            }

            if(/^\d+$/.test(userInputyear+userInputmonth+userInputday+userInputtime)){
                if((1900<=userInputyear&&userInputyear<2100)&&
                (0<userInputmonth&&userInputmonth<=12)&&
                (0<userInputday&&userInputday<getMaxDaysInMonth(userInputmonth,userInputyear))&&
                (0<userInputtime&&userInputtime<=24)){
                    if(userInputtime>22){
                        const nd = getNextDay(userInputyear,userInputmonth,userInputday);
                        start(nd.y,nd.m,nd.d,0,sex);
                        return 0;
                    }
                    start(userInputyear,userInputmonth,userInputday,userInputtime,sex);
                }else{
                    alert("请输入合法日期");
                }
            }else{
                alert("请输入数字");
            }
            // adjustLineHeight();
        }
function mapMonthGZToBoxes() {
    for(let i=0;i<12;i++){
        addInBox(jybd[pan.wholeYearMg[i]],(i+2)%12,'monthganzhi');
        }
    
}
function createOriginalDZ() {
    for(let i=0;i<12;i++){
            addInBox(zcym[(i+10)%12],i-2,'shengxiao');
        }
}
function clearElementContent(element) {
    if (element.hasAttribute('data-index')) {
        while (element.firstChild) {
            element.removeChild(element.firstChild);
        }
    }
}
function addInBox(text, position, className, Color, extraStyle = '') {  
    const textBox = document.querySelector(`.box[data-index="${(position + 10) % 12}"]`);
    
    if (textBox) {
        const targetElement = textBox.querySelector(`.${className}`);
        if (!targetElement) {
            const textSpan = document.createElement('span');
            textSpan.classList.add(className);
            textBox.appendChild(textSpan);
            const targetElement2 = textBox.querySelector(`.${className}`);
            const span = document.createElement('span');
            span.textContent = text;
            span.style.color = Color;
            span.style.cssText += extraStyle; // 添加额外样式
            targetElement2.appendChild(span);
        } else {
            const span = document.createElement('span');
            span.textContent = text;
            span.style.color = Color;
            span.style.cssText += extraStyle; // 添加额外样式
            targetElement.appendChild(span);
        }
    }
}

function autoColor(star) {
    switch (xing[1][xing[0].indexOf(star)]) {
        case "大":
            return "red";
        case "甲":
            return "purple";
        case "乙":
            return "#0044ff";
        case "丙":
            return "rgb(86, 156, 214)";
        case "丁":
            return "darkgray";
        case "戊":
            return "mistyrose";
        case "忌":
            return "black"
        default:
            return;
        
    }
}

function creatAllStarInBox(){
    const order=["大","甲","忌","乙","丙","丁","戊","*"];
    for(let j=0;j<order.length;j++){//绘制顺序, 从大到小
        for(let i=0;i<64;i++){
            if(xing[1][i]==order[j]){
                addInBox(xing[0][i],pan.xing[i],"lefttop1",autoColor(xing[0][i]));
                if(pan.xingyao[i]>-1){
                    addInBox(xy[pan.xingyao[i]],pan.xing[i],"xingyao-info");
                }else{
                    addInBox("一",pan.xing[i],"xingyao-info","white","opacity:0");
                }
                if(hua_list[pan.yearst_tg].indexOf(i)>=0){
                    addInBox(hua[hua_list[pan.yearst_tg].indexOf(i)],
                    pan.xing[i],
                    "hua4",
                    "white",
                    "background-color: #ff0000;border-radius: 4px;padding: 1px;"
                );
                }else{
                    addInBox("一",
                    pan.xing[i],
                    "hua4",
                    "white",
                    "opacity: 0;"
                );
                }
            }
        }
        for(let i=64;i<76;i++){
            if(xing[1][i]==order[j]){
                addInBox(xing[0][i],pan.xing[i],"tw_shen","gray");
            }
        }
        
    }
    for(let i=76;i<88;i++){
        addInBox(xing[0][i],pan.xing[i],"rightbottom","gray");
    }
    for(let i=100;i<112;i++){
        addInBox(xing[0][i],pan.xing[i],"rightbottom","gray");
    }
    for(let i=88;i<100;i++){
        addInBox(xing[0][i],pan.xing[i],"rightbottom","black");
    }
    
    // for(let i=0;i<4;i++){
    //     addInBox(hua[i],pan.hua[i],"hua4","white");
    // }
    for(let i=0;i<12;i++){
        addInBox(`${pan.daxian[i]}~${pan.daxian[i]+9}`,pan.minggong+i,"daxian","black");
    }
}

// window.addEventListener('resize', adjustLineHeight);



// function adjustLineHeight() {
//   // 获取窗口的当前宽度
//   var width = window.innerWidth;

//   // 获取目标元素
//   var element = document.querySelector('.lefttop1');

//   // 基于窗口宽度决定line-height的值
//   // 这里的条件和line-height的值需要根据实际情况调整
//     element.style.lineHeight = `${width/600}`;
// }

function parseDateAndStart() {
  // 解析当前URL
  const params = new URLSearchParams(window.location.search);
  
  // 获取'date'参数
  const date = params.get('date');
  let checkboxf = document.getElementById('f');
  let checkboxm = document.getElementById('m');
  if (date) {
      // 拆分'date'参数获取年、月、日、时
      const year = date.substring(0, 4);
      const month = date.substring(4, 6);
      const day = date.substring(6, 8);
      const hour = date.substring(8, 10);
      const sex = date.substring(10, 11);
      Yinput.value=parseInt(year);
        Minput.value=parseInt(month);
        Dinput.value=parseInt(day);
        Tinput.value=parseInt(hour);
        document.getElementById(sex==1?'m':'f').checked=true;
      start(year, month, day, hour, sex==1?1:-1);
  }else{
    Yinput.value=currentDate.getFullYear()*1;
        Minput.value=currentDate.getMonth()+1;
        Dinput.value=currentDate.getDate();
        Tinput.value=currentDate.getHours();
        document.getElementById('f').checked=true;
  }
}

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', parseDateAndStart);
    </script>
</body>
</html>